<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - SistemaContable</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="~/css/aurora-theme.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/menu-fixes.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/comprobantes-fiscales.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/clientes.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/dashboard-cards.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/entradas-diario.css" asp-append-version="true" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css" rel="stylesheet" />
    <style>
        .select2-container--bootstrap-5 .select2-selection__rendered img,
        .select2-results__option img {
            width: 20px;
            margin-right: 8px;
        }
        .dataTables_wrapper .row {
            margin-top: 10px;
            margin-bottom: 10px;
            width: 100%;
        }
        .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate {
            padding: 5px;
        }
        .dataTables_info {
            color: #6c757d !important;
        }
        table.dataTable {
            width: 100% !important;
            margin-bottom: 0 !important;
        }
    </style>
    @RenderSection("Styles", required: false)
</head>
<body>
    <div class="aurora-wrapper">
        <!-- Sidebar -->
        <aside class="aurora-sidebar">
            <div class="aurora-logo-container">
                <img src="~/images/logo.png" alt="Aurora" class="aurora-logo aurora-logo-large" />
            </div>
            <nav class="aurora-nav">
                <a href="/" class="aurora-nav-item active" data-title="Dashboard">
                    <span class="aurora-nav-icon"><i class="fas fa-home"></i></span>
                    <span>Dashboard</span>
                </a>
                <a href="javascript:void(0)" class="aurora-nav-item has-submenu" data-toggle="submenu" data-title="Configuración">
                    <span class="aurora-nav-icon"><i class="fas fa-cogs"></i></span>
                    <span>Configuración</span>
                </a>
                <div class="aurora-submenu">
                    <a href="/Empresas/Configurar" class="aurora-submenu-item" data-title="Empresa">
                        <i class="fas fa-building me-2"></i>Empresa
                    </a>
                    <a href="/Impuestos" class="aurora-submenu-item" data-title="Impuestos">
                        <i class="fas fa-percentage me-2"></i>Impuestos
                    </a>
                    <a href="/Familia" class="aurora-submenu-item" data-title="Familias">
                        <i class="fas fa-users me-2"></i>Familias
                    </a>
                    <a href="/Categoria" class="aurora-submenu-item" data-title="Categorías">
                        <i class="fas fa-tags me-2"></i>Categorías
                    </a>
                    <a href="/PlazoPago" class="aurora-submenu-item" data-title="Plazos de Pago">
                        <i class="fas fa-clock me-2"></i>Plazos de Pago
                    </a>
                    <a href="/configuracion/retenciones" class="aurora-submenu-item" data-title="Retenciones">
                        <i class="fas fa-hand-holding-usd me-2"></i>Retenciones
                    </a>
                    <a href="/configuracion/comprobantes-fiscales" class="aurora-submenu-item" data-title="Comprobantes Fiscales">
                        <i class="fas fa-file-invoice me-2"></i>Comprobantes Fiscales
                    </a>
                    <a href="/Usuarios" class="aurora-submenu-item" data-title="Usuarios">
                        <i class="fas fa-user-cog me-2"></i>Usuarios
                    </a>
                </div>
                
                <a href="javascript:void(0)" class="aurora-nav-item has-submenu" data-toggle="submenu" data-title="Ventas">
                    <span class="aurora-nav-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                    <span>Ventas</span>
                </a>
                <div class="aurora-submenu">
                    <a href="/ventas/facturas" class="aurora-submenu-item" data-title="Facturas">Facturas</a>
                    <a href="/ventas/clientes" class="aurora-submenu-item" data-title="Clientes">Clientes</a>
                    <a href="/ventas/cotizaciones" class="aurora-submenu-item" data-title="Cotizaciones">Cotizaciones</a>
                    <a href="/ventas/devoluciones" class="aurora-submenu-item" data-title="Devoluciones">Devoluciones</a>
                </div>
                
                <a href="javascript:void(0)" class="aurora-nav-item has-submenu" data-toggle="submenu" data-title="Compras">
                    <span class="aurora-nav-icon"><i class="fas fa-shopping-cart"></i></span>
                    <span>Compras</span>
                </a>
                <div class="aurora-submenu">
                    <a href="/compras/facturas" class="aurora-submenu-item" data-title="Facturas">Facturas</a>
                    <a href="/compras/proveedores" class="aurora-submenu-item" data-title="Proveedores">Proveedores</a>
                    <a href="/compras/gastos" class="aurora-submenu-item" data-title="Gastos">Gastos</a>
                    <a href="/compras/devoluciones" class="aurora-submenu-item" data-title="Devoluciones">Devoluciones</a>
                </div>
                
                <a href="javascript:void(0)" class="aurora-nav-item has-submenu" data-toggle="submenu" data-title="Inventario">
                    <span class="aurora-nav-icon"><i class="fas fa-boxes"></i></span>
                    <span>Inventario</span>
                </a>
                <div class="aurora-submenu">
                    <a href="/inventario/productos" class="aurora-submenu-item" data-title="Almacenes">
                        <i class="fas fa-warehouse me-2"></i>Almacenes
                    </a>
                    <a href="/inventario/servicios" class="aurora-submenu-item" data-title="Items">
                        <i class="fas fa-box me-2"></i>Items
                    </a>
                    <a href="/inventario/categorias" class="aurora-submenu-item" data-title="Categorías">
                        <i class="fas fa-tags me-2"></i>Categorías
                    </a>
                    <a href="/inventario/ajustes" class="aurora-submenu-item" data-title="Ajustes">
                        <i class="fas fa-sliders-h me-2"></i>Ajustes
                    </a>
                </div>
                
                <a href="javascript:void(0)" class="aurora-nav-item has-submenu" data-toggle="submenu" data-title="Bancos">
                    <span class="aurora-nav-icon"><i class="fas fa-university"></i></span>
                    <span>Bancos</span>
                </a>
                <div class="aurora-submenu">
                    <a href="/bancos/cuentas" class="aurora-submenu-item" data-title="Cuentas">Cuentas</a>
                    <a href="/bancos/transacciones" class="aurora-submenu-item" data-title="Transacciones">Transacciones</a>
                    <a href="/bancos/conciliacion" class="aurora-submenu-item" data-title="Conciliación">Conciliación</a>
                </div>
                
                <a href="javascript:void(0)" class="aurora-nav-item has-submenu" data-toggle="submenu" data-title="Contabilidad">
                    <span class="aurora-nav-icon"><i class="fas fa-calculator"></i></span>
                    <span>Contabilidad</span>
                </a>
                <div class="aurora-submenu">
                    <a href="/contabilidad/catalogo" class="aurora-submenu-item" data-title="Catálogo de cuentas">Catálogo de cuentas</a>
                    <a href="/contabilidad/entradas-diario" class="aurora-submenu-item" data-title="Entradas de diario">
                        <i class="fas fa-journal-whills me-2"></i>Entradas de diario
                    </a>
                    <a href="/contabilidad/libro-diario" class="aurora-submenu-item" data-title="Libro diario">Libro diario</a>
                    <a href="/contabilidad/libro-mayor" class="aurora-submenu-item" data-title="Libro mayor">Libro mayor</a>
                </div>
                
                <a href="javascript:void(0)" class="aurora-nav-item has-submenu" data-toggle="submenu" data-title="Reportes">
                    <span class="aurora-nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span>Reportes</span>
                </a>
                <div class="aurora-submenu">
                    <a href="/reportes/estado-resultados" class="aurora-submenu-item" data-title="Estado de resultados">Estado de resultados</a>
                    <a href="/reportes/balance-general" class="aurora-submenu-item" data-title="Balance general">Balance general</a>
                    <a href="/reportes/impuestos" class="aurora-submenu-item" data-title="Impuestos">Impuestos</a>
                    <a href="/reportes/ventas" class="aurora-submenu-item" data-title="Reportes de ventas">Reportes de ventas</a>
                </div>
            </nav>
            <div class="aurora-sidebar-toggler" id="sidebarCollapseToggler">
                <i class="fas fa-angle-left"></i>
            </div>
        </aside>

        <!-- Content Area -->
        <div class="aurora-content">
            <!-- Header -->
            <header class="aurora-header">
                <button class="btn btn-sm d-lg-none" id="sidebarToggler">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="aurora-header-search d-none">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" placeholder="Buscar..." />
                    </div>
                </div>
                <div class="aurora-header-actions">
                    <div class="aurora-header-icon">
                        <i class="fas fa-bell"></i>
                        <span class="aurora-notification-badge"></span>
                    </div>
                    <div class="aurora-header-icon">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <div class="dropdown">
                        <div class="aurora-header-icon" data-bs-toggle="dropdown">
                            <div class="aurora-user-avatar">
                                A
                            </div>
                        </div>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/perfil"><i class="fas fa-user me-2"></i> Perfil</a></li>
                            <li><a class="dropdown-item" href="/configuracion"><i class="fas fa-cog me-2"></i> Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt me-2"></i> Cerrar sesión</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="aurora-main">
                @RenderBody()
            </main>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script>
        // Simplemente monitorear que el DOM esté listo sin interferir con los eventos
        document.addEventListener('DOMContentLoaded', function() {
            // Solo verificar si hay problemas sin reemplazar elementos
            console.log('Layout DOM cargado.');
            
            // Asegurar que el cuerpo sea visible
            document.body.style.visibility = 'visible';
            
            // Verificar si el toggler ya tiene eventos asignados (respaldo)
            const sidebarToggler = document.getElementById('sidebarCollapseToggler');
            if (sidebarToggler && !sidebarToggler._hasToggleEvent) {
                sidebarToggler._hasToggleEvent = true;
                sidebarToggler.addEventListener('click', function() {
                    const wrapper = document.querySelector('.aurora-wrapper');
                    wrapper.classList.toggle('sidebar-collapsed');
                    
                    // Cambiar el ícono del toggler
                    const icon = this.querySelector('i');
                    if (wrapper.classList.contains('sidebar-collapsed')) {
                        icon.classList.remove('fa-angle-left');
                        icon.classList.add('fa-angle-right');
                    } else {
                        icon.classList.remove('fa-angle-right');
                        icon.classList.add('fa-angle-left');
                    }
                });
            }
        });
    </script>
    <script src="~/js/custom-menu.js?v=@DateTime.Now.Ticks"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggler para colapsar/expandir el sidebar
            document.getElementById('sidebarCollapseToggler')?.addEventListener('click', function() {
                const wrapper = document.querySelector('.aurora-wrapper');
                wrapper.classList.toggle('sidebar-collapsed');
                
                // Cambiar el ícono del toggler
                const icon = this.querySelector('i');
                if (wrapper.classList.contains('sidebar-collapsed')) {
                    icon.classList.remove('fa-angle-left');
                    icon.classList.add('fa-angle-right');
                } else {
                    icon.classList.remove('fa-angle-right');
                    icon.classList.add('fa-angle-left');
                }
            });

            // Mejorar la visualización en páginas específicas
            const currentPath = window.location.pathname.toLowerCase();
            if (currentPath.includes('/plazopago') || currentPath.includes('/retenciones') || currentPath.includes('/comprobantes') || currentPath.includes('/comprobantes-fiscales')) {
                // Forzar apertura del menú de configuración
                const configMenuItem = document.querySelector('.aurora-nav-item[data-title="Configuración"]');
                const configSubmenu = document.querySelector('.aurora-nav-item[data-title="Configuración"] + .aurora-submenu');
                
                if (configMenuItem && configSubmenu) {
                    configMenuItem.classList.add('expanded');
                    configSubmenu.classList.add('show');
                    
                    // Activar el elemento específico
                    if (currentPath.includes('/plazopago')) {
                        const plazoPagoItem = configSubmenu.querySelector('a[href*="/PlazoPago"]');
                        if (plazoPagoItem) plazoPagoItem.classList.add('active');
                    } else if (currentPath.includes('/retenciones')) {
                        const retencionesItem = configSubmenu.querySelector('a[href*="/Retenciones"]');
                        if (retencionesItem) retencionesItem.classList.add('active');
                    } else if (currentPath.includes('/comprobantes') || currentPath.includes('/comprobantes-fiscales')) {
                        const comprobantesItem = configSubmenu.querySelector('a[href*="/comprobantes"]');
                        if (comprobantesItem) comprobantesItem.classList.add('active');
                    }
                }
            }

            // Inicializar select2 con banderas
            $('.select2-flags').select2({
                theme: 'bootstrap-5',
                templateResult: formatOption,
                templateSelection: formatOption
            });
            
            // Función para formatear opciones con banderas
            function formatOption(option) {
                if (!option.id) return option.text;
                
                const flagCode = $(option.element).data('flag');
                if (!flagCode) return option.text;
                
                return $(`<span><img src="https://flagcdn.com/24x18/${flagCode}.png" alt="${option.text} flag" /> ${option.text}</span>`);
            }
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)
    <script>
        // Script de carga tardía para garantizar que el colapsador del sidebar funcione
        window.addEventListener('load', function() {
            // Verificar si el toggler tiene eventos después de que todo esté cargado
            setTimeout(function() {
                const sidebarToggler = document.getElementById('sidebarCollapseToggler');
                if (sidebarToggler) {
                    // Clonar el toggler original y reemplazarlo para eliminar posibles eventos conflictivos
                    const newToggler = sidebarToggler.cloneNode(true);
                    sidebarToggler.parentNode.replaceChild(newToggler, sidebarToggler);
                    
                    // Aplicar el evento de clic directamente
                    newToggler.addEventListener('click', function() {
                        const wrapper = document.querySelector('.aurora-wrapper');
                        wrapper.classList.toggle('sidebar-collapsed');
                        
                        // Cambiar el ícono del toggler
                        const icon = this.querySelector('i');
                        if (wrapper.classList.contains('sidebar-collapsed')) {
                            icon.classList.remove('fa-angle-left');
                            icon.classList.add('fa-angle-right');
                        } else {
                            icon.classList.remove('fa-angle-right');
                            icon.classList.add('fa-angle-left');
                        }
                    });
                }
            }, 500); // Esperar a que todo esté completamente cargado
        });
    </script>
</body>
</html>
